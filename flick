-- Fully Fixed Roblox Script
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "dor dor",
   LoadingTitle = "ah ah ah",
   LoadingSubtitle = "axel dor",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = "FixedConfig",
      FileName = "Config.json"
   },
   KeySystem = false,
})

-- Combat Tab
local CombatTab = Window:CreateTab("Combat", 4483362458)

local RagebotToggle = CombatTab:CreateToggle({
   Name = "RageBot (Head->Body->Body)",
   CurrentValue = false,
   Flag = "RagebotEnabled",
   Callback = function(Value)
       getgenv().RagebotEnabled = Value
   end,
})

local FOVToggle = CombatTab:CreateToggle({
   Name = "Show FOV Circle",
   CurrentValue = true,
   Flag = "FOVCircleEnabled",
   Callback = function(Value)
       getgenv().ShowFOV = Value
       updateFOVCircle()
   end,
})

local FOVColorPicker = CombatTab:CreateColorPicker({
   Name = "FOV Circle Color",
   Color = Color3.fromRGB(0, 255, 0),
   Flag = "FOVColor",
   Callback = function(Value)
       getgenv().FOVColor = Value
       updateFOVCircle()
   end
})

local FOVSlider = CombatTab:CreateSlider({
   Name = "FOV Circle Size",
   Range = {50, 300},
   Increment = 10,
   Suffix = "pixels",
   CurrentValue = 120,
   Flag = "FOVSize",
   Callback = function(Value)
       getgenv().FOVSize = Value
       updateFOVCircle()
   end,
})

-- Visuals Tab
local VisualsTab = Window:CreateTab("Visuals", 4483362458)

local ESPToggle = VisualsTab:CreateToggle({
   Name = "ESP Box",
   CurrentValue = false,
   Flag = "ESPEnabled",
   Callback = function(Value)
       getgenv().ESPEnabled = Value
       if Value then
           createESP()
       else
           removeESP()
       end
   end,
})

local ESPColorPicker = VisualsTab:CreateColorPicker({
   Name = "ESP Box Color",
   Color = Color3.fromRGB(255, 0, 0),
   Flag = "ESPColor",
   Callback = function(Value)
       getgenv().ESPColor = Value
       updateESPColors()
   end
})

local TracerToggle = VisualsTab:CreateToggle({
   Name = "Tracer Lines",
   CurrentValue = false,
   Flag = "TracerEnabled",
   Callback = function(Value)
       getgenv().TracerEnabled = Value
       if Value then
           createTracers()
       else
           removeTracers()
       end
   end,
})

-- FOV Circle Variables
local FOVCircle = nil
local screenCenter = Vector2.new()

-- Create centered FOV Circle
function createFOVCircle()
    if FOVCircle then FOVCircle:Remove() end
    
    FOVCircle = Drawing.new("Circle")
    FOVCircle.Visible = getgenv().ShowFOV or true
    FOVCircle.Color = getgenv().FOVColor or Color3.fromRGB(0, 255, 0)
    FOVCircle.Thickness = 2
    FOVCircle.NumSides = 64
    FOVCircle.Radius = getgenv().FOVSize or 120
    FOVCircle.Filled = false
    FOVCircle.Transparency = 1
    
    -- Set to screen center and keep it there
    local viewportSize = workspace.CurrentCamera.ViewportSize
    screenCenter = Vector2.new(viewportSize.X / 2, viewportSize.Y / 2)
    FOVCircle.Position = screenCenter
    
    -- Keep circle centered
    game:GetService("RunService").RenderStepped:Connect(function()
        if FOVCircle then
            FOVCircle.Visible = getgenv().ShowFOV or true
            FOVCircle.Position = screenCenter -- Always stay centered
        end
    end)
end

function updateFOVCircle()
    if FOVCircle then
        FOVCircle.Visible = getgenv().ShowFOV or true
        FOVCircle.Color = getgenv().FOVColor or Color3.fromRGB(0, 255, 0)
        FOVCircle.Radius = getgenv().FOVSize or 120
    else
        createFOVCircle()
    end
end

-- RageBot Variables
local aimSequence = {"Head", "UpperTorso", "LowerTorso"}
local currentAimIndex = 1
local lastAimTime = 0

-- Fixed RageBot Function
function findBestTarget()
    if not game.Players.LocalPlayer.Character then return nil end
    if not game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return nil end
    
    local bestTarget = nil
    local closestDistance = getgenv().FOVSize or 120
    local localPlayer = game.Players.LocalPlayer
    local localPos = localPlayer.Character.HumanoidRootPart.Position
    
    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= localPlayer and player.Character then
            local character = player.Character
            local humanoid = character:FindFirstChild("Humanoid")
            local rootPart = character:FindFirstChild("HumanoidRootPart")
            
            if humanoid and humanoid.Health > 0 and rootPart then
                -- Check if target is within FOV circle
                local screenPoint, onScreen = workspace.CurrentCamera:WorldToViewportPoint(rootPart.Position)
                if onScreen then
                    local distanceFromCenter = (Vector2.new(screenPoint.X, screenPoint.Y) - screenCenter).Magnitude
                    
                    if distanceFromCenter <= (getgenv().FOVSize or 120) then
                        local distance = (localPos - rootPart.Position).Magnitude
                        if distance < closestDistance then
                            closestDistance = distance
                            bestTarget = player
                        end
                    end
                end
            end
        end
    end
    
    return bestTarget
end

-- Working RageBot Aim Function
function rageBotAim()
    if not getgenv().RagebotEnabled then return end
    if not game.Players.LocalPlayer.Character then return end
    if not game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    
    local target = findBestTarget()
    if target and target.Character then
        local character = target.Character
        
        -- Get aim part based on sequence
        local aimPartName = aimSequence[currentAimIndex]
        local aimPart = character:FindFirstChild(aimPartName) or character:FindFirstChild("HumanoidRootPart")
        
        if aimPart then
            -- Direct camera aiming (working method)
            workspace.CurrentCamera.CFrame = CFrame.lookAt(
                workspace.CurrentCamera.CFrame.Position,
                aimPart.Position
            )
            
            -- Cycle to next aim part
            currentAimIndex = currentAimIndex % #aimSequence + 1
        end
    end
end

-- ESP Variables with better tracking
local ESPObjects = {}
local ESPConnections = {}

-- Fixed ESP Function
function createESP()
    removeESP() -- Clean up first
    
    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= game.Players.LocalPlayer then
            setupPlayerESP(player)
        end
    end
    
    -- Listen for new players
    ESPConnections.playerAdded = game.Players.PlayerAdded:Connect(function(player)
        if getgenv().ESPEnabled then
            setupPlayerESP(player)
        end
    end)
    
    -- Listen for character changes
    ESPConnections.characterAdded = game.Players.PlayerAdded:Connect(function(player)
        if getgenv().ESPEnabled and ESPObjects[player.Name] then
            wait(1) -- Wait for character to load
            setupPlayerESP(player)
        end
    end)
end

function setupPlayerESP(player)
    if ESPObjects[player.Name] then
        ESPObjects[player.Name]:Destroy()
    end
    
    local function createESPForCharacter(character)
        if not character then return end
        
        wait(0.5) -- Wait for character to fully load
        
        local highlight = Instance.new("Highlight")
        highlight.Name = "ESP_" .. player.Name
        highlight.Adornee = character
        highlight.Parent = game.CoreGui
        highlight.FillColor = getgenv().ESPColor or Color3.fromRGB(255, 0, 0)
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.FillTransparency = 0.3
        highlight.OutlineTransparency = 0
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        
        ESPObjects[player.Name] = highlight
        
        -- Update ESP when character changes
        character:WaitForChild("Humanoid").Died:Connect(function()
            if ESPObjects[player.Name] then
                ESPObjects[player.Name]:Destroy()
                ESPObjects[player.Name] = nil
            end
        end)
    end
    
    if player.Character then
        createESPForCharacter(player.Character)
    end
    
    player.CharacterAdded:Connect(createESPForCharacter)
end

function removeESP()
    for playerName, highlight in pairs(ESPObjects) do
        if highlight then
            highlight:Destroy()
        end
    end
    ESPObjects = {}
    
    for _, connection in pairs(ESPConnections) do
        connection:Disconnect()
    end
    ESPConnections = {}
end

function updateESPColors()
    for playerName, highlight in pairs(ESPObjects) do
        if highlight then
            highlight.FillColor = getgenv().ESPColor or Color3.fromRGB(255, 0, 0)
        end
    end
end

-- Tracer Variables
local TracerObjects = {}

function createTracers()
    removeTracers()
    
    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= game.Players.LocalPlayer and player.Character then
            setupPlayerTracer(player)
        end
    end
end

function setupPlayerTracer(player)
    if TracerObjects[player.Name] then
        TracerObjects[player.Name]:Remove()
    end
    
    local line = Drawing.new("Line")
    line.Visible = false
    line.Color = getgenv().ESPColor or Color3.fromRGB(255, 255, 0)
    line.Thickness = 2
    line.Transparency = 1
    
    TracerObjects[player.Name] = line
    
    -- Update tracer position
    game:GetService("RunService").RenderStepped:Connect(function()
        if getgenv().TracerEnabled and player.Character and game.Players.LocalPlayer.Character then
            local rootPart = player.Character:FindFirstChild("HumanoidRootPart")
            local localRoot = game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            
            if rootPart and localRoot then
                local screenPoint, onScreen = workspace.CurrentCamera:WorldToViewportPoint(rootPart.Position)
                local localScreenPoint = workspace.CurrentCamera:WorldToViewportPoint(localRoot.Position)
                
                if onScreen then
                    line.From = Vector2.new(localScreenPoint.X, localScreenPoint.Y)
                    line.To = Vector2.new(screenPoint.X, screenPoint.Y)
                    line.Visible = true
                else
                    line.Visible = false
                end
            else
                line.Visible = false
            end
        else
            line.Visible = false
        end
    end)
end

function removeTracers()
    for playerName, line in pairs(TracerObjects) do
        if line then
            line:Remove()
        end
    end
    TracerObjects = {}
end

-- Main loops
game:GetService("RunService").RenderStepped:Connect(function()
    rageBotAim() -- RageBot always runs when enabled
end)

-- Initialize
createFOVCircle()

-- Clean up on script end
game:GetService("Players").PlayerRemoving:Connect(function(player)
    if ESPObjects[player.Name] then
        ESPObjects[player.Name]:Destroy()
        ESPObjects[player.Name] = nil
    end
    if TracerObjects[player.Name] then
        TracerObjects[player.Name]:Remove()
        TracerObjects[player.Name] = nil
    end
end)

Rayfield:LoadConfiguration()
