-- Load NatHub UI Library from multiple sources
local NatHub = nil
local sources = {
    'https://raw.githubusercontent.com/ArdyBotzz/NatHub/refs/heads/master/Uisource.lua',
    'https://raw.githubusercontent.com/ArdyBotzz/NatHub/refs/heads/master/NatLibrary/Source.lua',
    'https://raw.githubusercontent.com/ArdyBotzz/NatHub/refs/heads/master/NatLibrary/SourceV2.lua'
}

for i, source in ipairs(sources) do
    local success, result = pcall(function()
        return loadstring(game:HttpGet(source))()
    end)
    if success and result then
        NatHub = result
        break
    end
end

if not NatHub then
    error("Failed to load NatHub UI from all sources")
end

-- Initialize NatHub UI
local Window = NatHub:CreateWindow("Survival Script", "Crash Survivors Hub")

-- Create Tabs
local CombatTab = Window:Tab("Combat", "rbxassetid://4483362458")
local VisualsTab = Window:Tab("Visuals", "rbxassetid://4483362458") 
local PerformanceTab = Window:Tab("Performance", "rbxassetid://4483362458")

-- Combat Tab Sections
local RageBotSection = CombatTab:Section("RageBot Settings")
local FOVSection = CombatTab:Section("FOV Settings")

-- RageBot Settings
local RagebotToggle = RageBotSection:Toggle("Enable RageBot", false, function(Value)
    getgenv().RagebotEnabled = Value
end)

local AimPartDropdown = RageBotSection:Dropdown("Aim Part", {"Head", "UpperTorso", "LowerTorso", "HumanoidRootPart", "Random"}, "Head", function(Value)
    getgenv().AimPart = Value
end)

local SmoothingSlider = RageBotSection:Slider("Aim Smoothing", 1, 20, 5, function(Value)
    getgenv().AimSmoothing = Value
end)

local AimKeyDropdown = RageBotSection:Dropdown("Aim Key", {"MouseButton2", "LeftControl", "LeftAlt", "CapsLock", "Q"}, "MouseButton2", function(Value)
    getgenv().AimKey = Value
end)

-- FOV Settings
local FOVToggle = FOVSection:Toggle("Show FOV Circle", true, function(Value)
    getgenv().ShowFOV = Value
    updateFOVCircle()
end)

local FOVSlider = FOVSection:Slider("FOV Size", 50, 300, 120, function(Value)
    getgenv().FOVSize = Value
    updateFOVCircle()
end)

local FOVColorPicker = FOVSection:ColorPicker("FOV Color", Color3.fromRGB(0, 255, 0), function(Value)
    getgenv().FOVColor = Value
    updateFOVCircle()
end)

local FOVTransparencySlider = FOVSection:Slider("FOV Transparency", 0, 1, 0.5, function(Value)
    getgenv().FOVTransparency = Value
    updateFOVCircle()
end)

-- Visuals Tab Sections
local ESPSection = VisualsTab:Section("ESP Settings")
local TracerSection = VisualsTab:Section("Tracer Settings")

-- ESP Settings
local ESPToggle = ESPSection:Toggle("Enable ESP", false, function(Value)
    getgenv().ESPEnabled = Value
    if Value then
        createESP()
    else
        removeESP()
    end
end)

local ESPColorPicker = ESPSection:ColorPicker("ESP Color", Color3.fromRGB(255, 0, 0), function(Value)
    getgenv().ESPColor = Value
    updateESPColors()
end)

local ESPUpdateSlider = ESPSection:Slider("ESP Update Rate", 1, 10, 5, function(Value)
    getgenv().ESPUpdateRate = Value
end)

local TeamColorToggle = ESPSection:Toggle("Team-Based Colors", true, function(Value)
    getgenv().TeamColors = Value
    updateAllColors()
end)

-- Tracer Settings
local TracerToggle = TracerSection:Toggle("Enable Tracers", false, function(Value)
    getgenv().TracerEnabled = Value
    if Value then
        createTracers()
    else
        removeTracers()
    end
end)

local TracerColorPicker = TracerSection:ColorPicker("Tracer Color", Color3.fromRGB(255, 255, 0), function(Value)
    getgenv().TracerColor = Value
    updateTracerColors()
end)

local ChamsToggle = ESPSection:Toggle("Wallhack Chams", false, function(Value)
    getgenv().Wallhack = Value
    if Value then
        createChams()
    else
        removeChams()
    end
end)

-- Performance Tab Sections
local PerformanceSection = PerformanceTab:Section("Performance Settings")
local GraphicsSection = PerformanceTab:Section("Graphics Settings")

-- Performance Settings
local DisableRenderingToggle = PerformanceSection:Toggle("Disable Rendering", false, function(Value)
    getgenv().DisableRendering = Value
    toggleRendering()
end)

local AntiLagToggle = PerformanceSection:Toggle("Anti-Lag Mode", false, function(Value)
    getgenv().AntiLag = Value
    toggleAntiLag()
end)

local ReduceParticlesToggle = PerformanceSection:Toggle("Reduce Particles", false, function(Value)
    getgenv().ReduceParticles = Value
    toggleParticles()
end)

-- Graphics Settings
local GraphicsSlider = GraphicsSection:Slider("Graphics Quality", 1, 10, 7, function(Value)
    setGraphicsQuality(Value)
end)

-- FOV Circle System
local FOVCircle = nil
local screenCenter = Vector2.new()

function createFOVCircle()
    if FOVCircle then FOVCircle:Remove() end
    
    FOVCircle = Drawing.new("Circle")
    FOVCircle.Visible = getgenv().ShowFOV or true
    FOVCircle.Color = getgenv().FOVColor or Color3.fromRGB(0, 255, 0)
    FOVCircle.Thickness = 2
    FOVCircle.NumSides = 32
    FOVCircle.Radius = getgenv().FOVSize or 120
    FOVCircle.Filled = false
    FOVCircle.Transparency = getgenv().FOVTransparency or 0.5
    
    local viewportSize = workspace.CurrentCamera.ViewportSize
    screenCenter = Vector2.new(viewportSize.X / 2, viewportSize.Y / 2)
    FOVCircle.Position = screenCenter
    
    -- Keep FOV circle centered
    game:GetService("RunService").RenderStepped:Connect(function()
        if FOVCircle then
            FOVCircle.Visible = getgenv().ShowFOV or true
            FOVCircle.Position = screenCenter
        end
    end)
end

function updateFOVCircle()
    if FOVCircle then
        FOVCircle.Visible = getgenv().ShowFOV or true
        FOVCircle.Radius = getgenv().FOVSize or 120
        FOVCircle.Color = getgenv().FOVColor or Color3.fromRGB(0, 255, 0)
        FOVCircle.Transparency = getgenv().FOVTransparency or 0.5
    else
        createFOVCircle()
    end
end

-- Stable RageBot System
function getAimPart(character)
    local aimPart = getgenv().AimPart or "Head"
    
    if aimPart == "Random" then
        local parts = {"Head", "UpperTorso", "LowerTorso", "HumanoidRootPart"}
        aimPart = parts[math.random(1, #parts)]
    end
    
    return character:FindFirstChild(aimPart) or character:FindFirstChild("HumanoidRootPart")
end

function isAimKeyPressed()
    local aimKey = getgenv().AimKey or "MouseButton2"
    local inputService = game:GetService("UserInputService")
    
    if aimKey == "MouseButton2" then
        return inputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2)
    else
        return inputService:IsKeyDown(Enum.KeyCode[aimKey])
    end
end

function findBestTarget()
    if not game.Players.LocalPlayer.Character then return nil end
    local localRoot = game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not localRoot then return nil end
    
    local bestTarget = nil
    local closestDistance = getgenv().FOVSize or 120
    local localPos = localRoot.Position
    
    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= game.Players.LocalPlayer and player.Character then
            local character = player.Character
            local humanoid = character:FindFirstChild("Humanoid")
            local rootPart = character:FindFirstChild("HumanoidRootPart")
            
            if humanoid and humanoid.Health > 0 and rootPart then
                local screenPoint, onScreen = workspace.CurrentCamera:WorldToViewportPoint(rootPart.Position)
                if onScreen then
                    local distanceFromCenter = (Vector2.new(screenPoint.X, screenPoint.Y) - screenCenter).Magnitude
                    
                    if distanceFromCenter <= (getgenv().FOVSize or 120) then
                        local distance = (localPos - rootPart.Position).Magnitude
                        if distance < closestDistance then
                            closestDistance = distance
                            bestTarget = player
                        end
                    end
                end
            end
        end
    end
    
    return bestTarget
end

function smoothAim(targetPosition)
    local camera = workspace.CurrentCamera
    local currentCFrame = camera.CFrame
    local targetCFrame = CFrame.lookAt(currentCFrame.Position, targetPosition)
    
    local smoothing = getgenv().AimSmoothing or 5
    local smoothFactor = 1 / smoothing
    
    return currentCFrame:Lerp(targetCFrame, smoothFactor)
end

function rageBotAim()
    if not getgenv().RagebotEnabled then return end
    if not isAimKeyPressed() then return end
    if not game.Players.LocalPlayer.Character then return end
    
    local target = findBestTarget()
    if target and target.Character then
        local aimPart = getAimPart(target.Character)
        if aimPart then
            local camera = workspace.CurrentCamera
            local newCFrame = smoothAim(aimPart.Position)
            camera.CFrame = newCFrame
        end
    end
end

-- Optimized ESP System
local ESPObjects = {}
local ESPUpdateConnection = nil
local lastESPUpdate = 0

function getTeamColor(player)
    if getgenv().TeamColors then
        if game.Players.LocalPlayer.Team == player.Team then
            return Color3.fromRGB(0, 255, 0) -- Green for teammates
        else
            return Color3.fromRGB(255, 0, 0) -- Red for enemies
        end
    else
        return getgenv().ESPColor or Color3.fromRGB(255, 0, 0)
    end
end

function createESP()
    removeESP()
    
    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= game.Players.LocalPlayer then
            setupPlayerESP(player)
        end
    end
    
    ESPUpdateConnection = game:GetService("RunService").RenderStepped:Connect(function()
        local now = tick()
        local updateRate = getgenv().ESPUpdateRate or 5
        local updateInterval = 1 / updateRate
        
        if now - lastESPUpdate >= updateInterval then
            updateESP()
            lastESPUpdate = now
        end
    end)
    
    game.Players.PlayerAdded:Connect(function(player)
        if getgenv().ESPEnabled then
            setupPlayerESP(player)
        end
    end)
end

function setupPlayerESP(player)
    if ESPObjects[player.Name] then
        ESPObjects[player.Name]:Destroy()
    end
    
    local function createESPForCharacter(character)
        if not character then return end
        
        wait(0.3) -- Wait for character to load
        
        local highlight = Instance.new("Highlight")
        highlight.Name = "ESP_" .. player.Name
        highlight.Adornee = character
        highlight.Parent = game.CoreGui
        highlight.FillColor = getTeamColor(player)
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.FillTransparency = 0.4
        highlight.OutlineTransparency = 0
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        
        ESPObjects[player.Name] = {
            Highlight = highlight,
            Player = player
        }
    end
    
