-- Load a working UI Library
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/xHeptc/Kavo-UI-Library/main/source.lua"))()
local Window = Library.CreateLib("Combat Script", "Sentinel")

-- Initialize global variables
getgenv().RagebotEnabled = false
getgenv().AimPart = "Head"
getgenv().AimSmoothing = 3
getgenv().ShowFOV = true
getgenv().FOVSize = 80
getgenv().ESPEnabled = false
getgenv().TracerEnabled = false
getgenv().ChamsEnabled = false
getgenv().DisableRendering = false
getgenv().AntiLag = false

-- Create tabs
local CombatTab = Window:NewTab("Combat")
local VisualsTab = Window:NewTab("Visuals")
local PerformanceTab = Window:NewTab("Performance")

-- Combat Tab
local CombatSection = CombatTab:NewSection("Aimbot")

local RageToggle = CombatSection:NewToggle("Enable RageBot", "Toggle RageBot", function(state)
    getgenv().RagebotEnabled = state
    print("RageBot:", state)
end)

local AimPart = CombatSection:NewDropdown("Aim Part", {"Head", "UpperTorso", "LowerTorso", "HumanoidRootPart", "Random"}, function(option)
    getgenv().AimPart = option
    print("Aim Part:", option)
end)

local SmoothSlider = CombatSection:NewSlider("Aim Smoothing", "Smoothing level", 10, 1, function(value)
    getgenv().AimSmoothing = value
    print("Smoothing:", value)
end)

local FOVSection = CombatTab:NewSection("FOV Settings")

local FOVToggle = FOVSection:NewToggle("Show FOV Circle", "Toggle FOV", function(state)
    getgenv().ShowFOV = state
    updateFOVCircle()
    print("FOV Circle:", state)
end)

local FOVSize = FOVSection:NewSlider("FOV Size", "FOV radius", 200, 30, function(value)
    getgenv().FOVSize = value
    updateFOVCircle()
    print("FOV Size:", value)
end)

-- Visuals Tab
local VisualsSection = VisualsTab:NewSection("ESP Settings")

local ESPToggle = VisualsSection:NewToggle("Enable ESP", "Toggle ESP", function(state)
    getgenv().ESPEnabled = state
    if state then
        createESP()
    else
        removeESP()
    end
    print("ESP:", state)
end)

local TracerToggle = VisualsSection:NewToggle("Enable Tracers", "Toggle Tracers", function(state)
    getgenv().TracerEnabled = state
    if state then
        createTracers()
    else
        removeTracers()
    end
    print("Tracers:", state)
end)

local ChamsToggle = VisualsSection:NewToggle("Enable Chams", "Toggle Chams", function(state)
    getgenv().ChamsEnabled = state
    if state then
        createChams()
    else
        removeChams()
    end
    print("Chams:", state)
end)

-- Performance Tab
local PerformanceSection = PerformanceTab:NewSection("Performance Settings")

local RenderToggle = PerformanceSection:NewToggle("Disable Rendering", "Boost FPS", function(state)
    getgenv().DisableRendering = state
    toggleRendering()
    print("Disable Rendering:", state)
end)

local AntiLagToggle = PerformanceSection:NewToggle("Anti Lag Mode", "Reduce lag", function(state)
    getgenv().AntiLag = state
    toggleAntiLag()
    print("Anti Lag:", state)
end)

local GraphicsSlider = PerformanceSection:NewSlider("Graphics Level", "Quality", 10, 1, function(value)
    setGraphicsQuality(value)
    print("Graphics Level:", value)
end)

-- Backend Systems
local FOVCircle = nil
local screenCenter = Vector2.new()
local ESPObjects = {}
local TracerObjects = {}
local ChamObjects = {}
local RenderingConnection = nil

-- FOV Circle System
function createFOVCircle()
    if FOVCircle then 
        FOVCircle:Remove()
        FOVCircle = nil
    end
    
    FOVCircle = Drawing.new("Circle")
    FOVCircle.Visible = getgenv().ShowFOV
    FOVCircle.Color = Color3.fromRGB(0, 255, 0)
    FOVCircle.Thickness = 2
    FOVCircle.NumSides = 32
    FOVCircle.Radius = getgenv().FOVSize
    FOVCircle.Filled = false
    FOVCircle.Transparency = 0.5
    
    local viewportSize = workspace.CurrentCamera.ViewportSize
    screenCenter = Vector2.new(viewportSize.X / 2, viewportSize.Y / 2)
    FOVCircle.Position = screenCenter
    
    print("FOV Circle Created")
end

function updateFOVCircle()
    if FOVCircle then
        FOVCircle.Visible = getgenv().ShowFOV
        FOVCircle.Radius = getgenv().FOVSize
    else
        createFOVCircle()
    end
end

-- RageBot System
function getAimPart(character)
    local aimPart = getgenv().AimPart
    if aimPart == "Random" then
        local parts = {"Head", "UpperTorso", "LowerTorso", "HumanoidRootPart"}
        aimPart = parts[math.random(1, #parts)]
    end
    
    local part = character:FindFirstChild(aimPart)
    if not part then
        part = character:FindFirstChild("HumanoidRootPart")
    end
    
    return part
end

function findBestTarget()
    if not game.Players.LocalPlayer or not game.Players.LocalPlayer.Character then 
        return nil 
    end
    
    local localRoot = game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not localRoot then return nil end
    
    local bestTarget = nil
    local closestDistance = math.huge
    local localPos = localRoot.Position
    
    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= game.Players.LocalPlayer and player.Character then
            local character = player.Character
            local humanoid = character:FindFirstChild("Humanoid")
            local rootPart = character:FindFirstChild("HumanoidRootPart")
            
            if humanoid and humanoid.Health > 0 and rootPart then
                local screenPoint, onScreen = workspace.CurrentCamera:WorldToViewportPoint(rootPart.Position)
                if onScreen then
                    local distanceFromCenter = (Vector2.new(screenPoint.X, screenPoint.Y) - screenCenter).Magnitude
                    local fovSize = getgenv().FOVSize
                    
                    if distanceFromCenter <= fovSize then
                        local distance = (localPos - rootPart.Position).Magnitude
                        if distance < closestDistance then
                            closestDistance = distance
                            bestTarget = player
                        end
                    end
                end
            end
        end
    end
    
    return bestTarget
end

function smoothAim(targetPosition)
    local camera = workspace.CurrentCamera
    local currentCFrame = camera.CFrame
    local targetCFrame = CFrame.lookAt(currentCFrame.Position, targetPosition)
    local smoothing = getgenv().AimSmoothing
    local smoothFactor = 1 / math.max(smoothing, 1)
    
    return currentCFrame:Lerp(targetCFrame, smoothFactor)
end

function rageBotAim()
    if not getgenv().RagebotEnabled then return end
    if not game.Players.LocalPlayer or not game.Players.LocalPlayer.Character then return end
    
    local target = findBestTarget()
    if target and target.Character then
        local aimPart = getAimPart(target.Character)
        if aimPart then
            local newCFrame = smoothAim(aimPart.Position)
            workspace.CurrentCamera.CFrame = newCFrame
        end
    end
end

-- ESP System
function createESP()
    removeESP()
    
    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= game.Players.LocalPlayer then
            local function setupPlayer()
                if player.Character then
                    local highlight = Instance.new("Highlight")
                    highlight.Name = "ESP_" .. player.Name
                    highlight.Adornee = player.Character
                    highlight.Parent = game.CoreGui
                    highlight.FillColor = Color3.fromRGB(255, 0, 0)
                    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
                    highlight.FillTransparency = 0.4
                    highlight.OutlineTransparency = 0
                    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                    
                    ESPObjects[player.Name] = highlight
                end
            end
            
            setupPlayer()
            player.CharacterAdded:Connect(setupPlayer)
        end
    end
    print("ESP Created")
end

function removeESP()
    for name, highlight in pairs(ESPObjects) do
        if highlight then
            highlight:Destroy()
        end
    end
    ESPObjects = {}
    print("ESP Removed")
end

-- Tracer System
function createTracers()
    removeTracers()
    
    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= game.Players.LocalPlayer then
            local line = Drawing.new("Line")
            line.Visible = false
            line.Color = Color3.fromRGB(255, 255, 0)
            line.Thickness = 2
            TracerObjects[player.Name] = line
        end
    end
    print("Tracers Created")
end

function removeTracers()
    for name, line in pairs(TracerObjects) do
        if line then
            line:Remove()
        end
    end
    TracerObjects = {}
    print("Tracers Removed")
end

-- Chams System
function createChams()
    removeChams()
    
    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= game.Players.LocalPlayer and player.Character then
            for _, part in pairs(player.Character:GetChildren()) do
                if part:IsA("BasePart") then
                    part.LocalTransparencyModifier = 0.3
                    ChamObjects[part] = true
                end
            end
        end
    end
    print("Chams Created")
end

function removeChams()
    for part, _ in pairs(ChamObjects) do
        if part and part.Parent then
            part.LocalTransparencyModifier = 0
        end
    end
    ChamObjects = {}
    print("Chams Removed")
end

-- Performance Systems
function toggleRendering()
    if RenderingConnection then
        RenderingConnection:Disconnect()
        RenderingConnection = nil
    end
    
    if getgenv().DisableRendering then
        RenderingConnection = game:GetService("RunService").RenderStepped:Connect(function()
            game:GetService("RunService"):Set3dRenderingEnabled(false)
        end)
        print("Rendering Disabled")
    else
        game:GetService("RunService"):Set3dRenderingEnabled(true)
        print("Rendering Enabled")
    end
end

function toggleAntiLag()
    if getgenv().AntiLag then
        setGraphicsQuality(1)
        game:GetService("Lighting").GlobalShadows = false
        game:GetService("Lighting").FogEnd = 100000
        print("Anti Lag Enabled")
    else
        setGraphicsQuality(7)
        game:GetService("Lighting").GlobalShadows = true
        print("Anti Lag Disabled")
    end
end

function setGraphicsQuality(level)
    local settings = game:GetService("UserGameSettings")
    settings:SetQualityLevel(level)
end

-- Main loop
game:GetService("RunService").RenderStepped:Connect(function()
    -- Update FOV circle position
    if FOVCircle then
        local viewportSize = workspace.CurrentCamera.ViewportSize
        screenCenter = Vector2.new(viewportSize.X / 2, viewportSize.Y / 2)
        FOVCircle.Position = screenCenter
    end
    
    -- RageBot aiming
    rageBotAim()
    
    -- Update tracers
    if getgenv().TracerEnabled then
        for playerName, line in pairs(TracerObjects) do
            local player = game.Players:FindFirstChild(playerName)
            if player and player.Character and game.Players.LocalPlayer.Character then
                local rootPart = player.Character:FindFirstChild("HumanoidRootPart")
                local localRoot = game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                
                if rootPart and localRoot then
                    local screenPoint, onScreen = workspace.CurrentCamera:WorldToViewportPoint(rootPart.Position)
                    local localScreenPoint = workspace.CurrentCamera:WorldToViewportPoint(localRoot.Position)
                    
                    if onScreen then
                        line.From = Vector2.new(localScreenPoint.X, localScreenPoint.Y)
                        line.To = Vector2.new(screenPoint.X, screenPoint.Y)
                        line.Visible = true
                    else
                        line.Visible = false
                    end
                else
                    line.Visible = false
                end
            else
                line.Visible = false
            end
        end
    end
end)

-- Initialize
createFOVCircle()
print("Combat Script Loaded Successfully!")

-- Auto-cleanup
game:GetService("Players").PlayerRemoving:Connect(function(player)
    if ESPObjects[player.Name] then
        ESPObjects[player.Name]:Destroy()
        ESPObjects[player.Name] = nil
    end
    if TracerObjects[player.Name] then
        TracerObjects[player.Name]:Remove()
        TracerObjects[player.Name] = nil
    end
end)
