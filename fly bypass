-- == ULTIMATE INDEXINSTANCE BYPASS ==
-- Author: Colin 
-- Description: Advanced IndexInstance bypass with multiple hooks

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "Ultimate IndexInstance Bypass",
    LoadingTitle = "IndexInstance Bypass",
    LoadingSubtitle = "by Colin",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "IndexInstanceBypass",
        FileName = "Config"
    },
    Discord = {
        Enabled = false,
        Invite = "noinvite",
        RememberJoins = true
    },
    KeySystem = false,
})

local MainTab = Window:CreateTab("Core Bypass", 4483362458)
local AdvancedTab = Window:CreateTab("Advanced", 4483362458)

-- A. MULTI-LAYER HOOK SYSTEM
getgenv().UltimateHooks = {
    IndexHook = nil,
    NamecallHook = nil,
    NewindexHook = nil
}

-- B. CORE INDEXINSTANCE BYPASS
local CoreSection = MainTab:CreateSection("Core IndexInstance Bypass")

local EnableIndexBypass = MainTab:CreateToggle({
    Name = "Enable IndexInstance Bypass",
    CurrentValue = false,
    Flag = "EnableIndexBypass",
    Callback = function(Value)
        if Value then
            EnableMultiLayerBypass()
        else
            DisableMultiLayerBypass()
        end
    end,
})

local BypassFlyDetection = MainTab:CreateToggle({
    Name = "Bypass Fly Detection",
    CurrentValue = false,
    Flag = "BypassFlyDetection",
    Callback = function(Value)
        getgenv().BypassFlyDetection = Value
    end,
})

local BypassVelocityCheck = MainTab:CreateToggle({
    Name = "Bypass Velocity Check",
    CurrentValue = false,
    Flag = "BypassVelocityCheck",
    Callback = function(Value)
        getgenv().BypassVelocityCheck = Value
    end,
})

-- C. ADVANCED BYPASS METHODS
local AdvancedSection = AdvancedTab:CreateSection("Advanced Bypass Methods")

local HookNamecall = AdvancedTab:CreateToggle({
    Name = "Hook Namecall Method",
    CurrentValue = false,
    Flag = "HookNamecall",
    Callback = function(Value)
        getgenv().HookNamecallEnabled = Value
        if Value then
            EnableNamecallHook()
        end
    end,
})

local HookNewindex = AdvancedTab:CreateToggle({
    Name = "Hook Newindex Method", 
    CurrentValue = false,
    Flag = "HookNewindex",
    Callback = function(Value)
        getgenv().HookNewindexEnabled = Value
        if Value then
            EnableNewindexHook()
        end
    end,
})

local AntiHookDetection = AdvancedTab:CreateToggle({
    Name = "Anti-Hook Detection",
    CurrentValue = false,
    Flag = "AntiHookDetection",
    Callback = function(Value)
        getgenv().AntiHookDetectionEnabled = Value
        if Value then
            EnableAntiHookDetection()
        end
    end,
})

-- D. MULTI-LAYER BYPASS IMPLEMENTATION
function EnableMultiLayerBypass()
    -- Layer 1: Basic IndexInstance Hook
    local mt = getrawmetatable(game)
    if not mt then 
        Rayfield:Notify({
            Title = "Error",
            Content = "Cannot get metatable!",
            Duration = 3
        })
        return
    end
    
    setreadonly(mt, false)
    
    getgenv().UltimateHooks.IndexHook = mt.__index
    mt.__index = newcclosure(function(self, key)
        local success, result = pcall(function()
            -- Advanced detection blocking
            local keyStr = tostring(key):lower()
            
            -- Fly detection blocking
            if getgenv().BypassFlyDetection then
                if keyStr:find("fly") or keyStr:find("flight") or keyStr:find("noclip") then
                    return nil
                end
                
                if keyStr:find("body") and (keyStr:find("velocity") or keyStr:find("position") or keyStr:find("gyro")) then
                    if self:IsA("BasePart") then
                        -- Return fake values for body movers
                        if key == "Velocity" then
                            return Vector3.new(0, 0, 0)
                        elseif key == "Position" then
                            return self.Position
                        end
                    end
                end
            end
            
            -- Velocity check blocking
            if getgenv().BypassVelocityCheck then
                if keyStr:find("velocity") and self:IsA("BasePart") then
                    -- Return zero velocity to avoid detection
                    return Vector3.new(0, 0, 0)
                end
            end
            
            -- Anti-cheat keyword blocking
            local blockedKeywords = {"cheat", "hack", "exploit", "script", "inject"}
            for _, keyword in pairs(blockedKeywords) do
                if keyStr:find(keyword) then
                    return nil
                end
            end
            
            -- Humanoid state spoofing
            if keyStr:find("state") and self:IsA("Humanoid") then
                return Enum.HumanoidStateType.Running
            end
            
            -- Platform stand blocking
            if keyStr:find("platform") and self:IsA("Humanoid") then
                return false
            end
            
            return getgenv().UltimateHooks.IndexHook(self, key)
        end)
        
        return success and result or getgenv().UltimateHooks.IndexHook(self, key)
    end)
    
    setreadonly(mt, true)
    
    -- Layer 2: Additional protection
    EnableAdditionalProtection()
    
    Rayfield:Notify({
        Title = "IndexInstance Bypass",
        Content = "Multi-layer bypass activated!",
        Duration = 3
    })
end

function EnableNamecallHook()
    local mt = getrawmetatable(game)
    if not mt then return end
    
    setreadonly(mt, false)
    
    getgenv().UltimateHooks.NamecallHook = mt.__namecall
    mt.__namecall = newcclosure(function(self, ...)
        local method = getnamecallmethod()
        local args = {...}
        
        if getgenv().HookNamecallEnabled then
            local methodStr = tostring(method):lower()
            
            -- Block kick/ban methods
            if methodStr:find("kick") or methodStr:find("ban") then
                return nil
            end
            
            -- Block detection calls
            if methodStr:find("findfirstchild") then
                local argStr = tostring(args[1]):lower()
                if argStr:find("fly") or argStr:find("cheat") or argStr:find("hack") then
                    return nil
                end
            end
            
            -- Block remote event calls for detection
            if methodStr:find("fireserver") then
                if tostring(self):lower():find("detection") or tostring(self):lower():find("anticheat") then
                    return nil
                end
            end
        end
        
        return getgenv().UltimateHooks.NamecallHook(self, ...)
    end)
    
    setreadonly(mt, true)
end

function EnableNewindexHook()
    local mt = getrawmetatable(game)
    if not mt then return end
    
    setreadonly(mt, false)
    
    getgenv().UltimateHooks.NewindexHook = mt.__newindex
    mt.__newindex = newcclosure(function(self, key, value)
        if getgenv().HookNewindexEnabled then
            local keyStr = tostring(key):lower()
            
            -- Block setting detection variables
            if keyStr:find("fly") or keyStr:find("cheat") or keyStr:find("detection") then
                return nil
            end
            
            -- Block velocity modifications that could trigger detection
            if keyStr:find("velocity") and self:IsA("BasePart") then
                if typeof(value) == "Vector3" and value.Y > 50 then
                    -- Limit vertical velocity to avoid fly detection
                    value = Vector3.new(value.X, math.min(value.Y, 50), value.Z)
                end
            end
        end
        
        return getgenv().UltimateHooks.NewindexHook(self, key, value)
    end)
    
    setreadonly(mt, true)
end

function EnableAntiHookDetection()
    -- Bypass common hook detection methods
    local oldCheckCaller = debug.info
    local oldGetConstants = debug.getconstants
    
    -- Spoof debug information
    debug.info = function(level, what)
        if getgenv().AntiHookDetectionEnabled then
            if what == "f" then
                return "LegitimateFunction"
            end
        end
        return oldCheckCaller(level, what)
    end
    
    -- Spoof constants
    debug.getconstants = function(func)
        if getgenv().AntiHookDetectionEnabled then
            local constants = oldGetConstants(func)
            local spoofedConstants = {}
            
            for _, constant in pairs(constants) do
                if tostring(constant):lower():find("hook") or tostring(constant):lower():find("bypass") then
                    table.insert(spoofedConstants, "legitimate_code")
                else
                    table.insert(spoofedConstants, constant)
                end
            end
            
            return spoofedConstants
        end
        return oldGetConstants(func)
    end
end

function EnableAdditionalProtection()
    -- Protection against common detection methods
    
    -- 1. Fake humanoid states
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer
    
    LocalPlayer.CharacterAdded:Connect(function(character)
        local humanoid = character:WaitForChild("Humanoid")
        
        -- Spoof humanoid state changes
        humanoid.StateChanged:Connect(function(oldState, newState)
            if getgenv().BypassFlyDetection then
                if newState == Enum.HumanoidStateType.Freefall then
                    -- Immediately change to running state
                    humanoid:ChangeState(Enum.HumanoidStateType.Running)
                end
            end
        end)
    end)
    
    -- 2. Velocity monitoring and spoofing
    local RunService = game:GetService("RunService")
    RunService.Heartbeat:Connect(function()
        if getgenv().BypassVelocityCheck then
            local character = LocalPlayer.Character
            if character then
                local rootPart = character:FindFirstChild("HumanoidRootPart")
                if rootPart then
                    -- Spoof velocity to avoid detection
                    if rootPart.Velocity.Y > 50 then
                        -- Add random noise to avoid pattern detection
                        rootPart.Velocity = Vector3.new(
                            rootPart.Velocity.X,
                            math.random(40, 50),
                            rootPart.Velocity.Z
                        )
                    end
                end
            end
        end
    end)
end

function DisableMultiLayerBypass()
    local mt = getrawmetatable(game)
    if not mt then return end
    
    setreadonly(mt, false)
    
    -- Restore original hooks
    if getgenv().UltimateHooks.IndexHook then
        mt.__index = getgenv().UltimateHooks.IndexHook
    end
    
    if getgenv().UltimateHooks.NamecallHook then
        mt.__namecall = getgenv().UltimateHooks.NamecallHook
    end
    
    if getgenv().UltimateHooks.NewindexHook then
        mt.__newindex = getgenv().UltimateHooks.NewindexHook
    end
    
    setreadonly(mt, true)
    
    Rayfield:Notify({
        Title = "IndexInstance Bypass",
        Content = "All hooks disabled!",
        Duration = 3
    })
end

-- E. QUICK PRESETS
local PresetSection = MainTab:CreateSection("Quick Presets")

MainTab:CreateButton({
    Name = "Enable All Protections",
    Callback = function()
        EnableIndexBypass:Set(true)
        BypassFlyDetection:Set(true)
        BypassVelocityCheck:Set(true)
        HookNamecall:Set(true)
        HookNewindex:Set(true)
        AntiHookDetection:Set(true)
        
        Rayfield:Notify({
            Title = "All Protections",
            Content = "All bypass methods activated!",
            Duration = 3
        })
    end,
})

-- F. INITIALIZATION
Rayfield:Notify({
    Title = "Ultimate IndexInstance Bypass",
    Content = "Enable core bypass first, then additional protections!",
    Duration = 5,
    Image = 4483362458
})
