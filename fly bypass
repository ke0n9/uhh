local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "Stealth Fly",
    LoadingTitle = "Stealth Fly",
    LoadingSubtitle = "by axel",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "StealthFly",
        FileName = "Config"
    },
    Discord = {
        Enabled = false,
        Invite = "noinvite",
        RememberJoins = true
    },
    KeySystem = false,
})

local MainTab = Window:CreateTab("Main", 4483362458)
local ProtectionTab = Window:CreateTab("Protection", 4483362458)

getgenv().Stealth = {
    Active = false,
    Hooks = {}
}

local FlyToggle = MainTab:CreateToggle({
    Name = "Enable Fly",
    CurrentValue = false,
    Flag = "FlyEnabled",
    Callback = function(Value)
        if Value then
            StartStealthFly()
        else
            StopStealthFly()
        end
    end,
})

local FlySpeed = MainTab:CreateSlider({
    Name = "Fly Speed",
    Range = {10, 100},
    Increment = 5,
    Suffix = "studs/s",
    CurrentValue = 50,
    Flag = "FlySpeed",
    Callback = function(Value)
        getgenv().FlySpeed = Value
    end,
})

local FlyKeybind = MainTab:CreateKeybind({
    Name = "Fly Keybind",
    CurrentKeybind = "F",
    HoldToInteract = false,
    Flag = "FlyKeybind",
    Callback = function(Key)
        getgenv().FlyKey = Key
    end,
})

local ProtectionToggle = ProtectionTab:CreateToggle({
    Name = "Enable Protection",
    CurrentValue = false,
    Flag = "ProtectionEnabled",
    Callback = function(Value)
        if Value then
            EnableProtection()
        else
            DisableProtection()
        end
    end,
})

local AntiKickToggle = ProtectionTab:CreateToggle({
    Name = "Anti-Kick",
    CurrentValue = false,
    Flag = "AntiKickEnabled",
    Callback = function(Value)
        getgenv().AntiKick = Value
        if Value then
            SetupAntiKick()
        end
    end,
})

function EnableProtection()
    local mt = getrawmetatable(game)
    setreadonly(mt, false)
    
    getgenv().Stealth.Hooks.Index = mt.__index
    mt.__index = newcclosure(function(self, key)
        local keyStr = tostring(key):lower()
        
        if keyStr:find("fly") or keyStr:find("flight") then
            return nil
        end
        
        if keyStr:find("velocity") and self:IsA("BasePart") then
            return Vector3.new(0, 0, 0)
        end
        
        if keyStr:find("body") and (keyStr:find("velocity") or keyStr:find("position")) then
            if self:IsA("BasePart") then
                for _, child in pairs(self:GetChildren()) do
                    if child:IsA("BodyVelocity") or child:IsA("BodyPosition") then
                        return nil
                    end
                end
            end
        end
        
        return getgenv().Stealth.Hooks.Index(self, key)
    end)
    
    getgenv().Stealth.Hooks.Namecall = mt.__namecall
    mt.__namecall = newcclosure(function(self, ...)
        local method = getnamecallmethod()
        
        if tostring(method):find("Kick") or tostring(method):find("Ban") then
            return nil
        end
        
        return getgenv().Stealth.Hooks.Namecall(self, ...)
    end)
    
    setreadonly(mt, true)
end

function DisableProtection()
    local mt = getrawmetatable(game)
    if not mt then return end
    
    setreadonly(mt, false)
    
    if getgenv().Stealth.Hooks.Index then
        mt.__index = getgenv().Stealth.Hooks.Index
    end
    
    if getgenv().Stealth.Hooks.Namecall then
        mt.__namecall = getgenv().Stealth.Hooks.Namecall
    end
    
    setreadonly(mt, true)
end

function SetupAntiKick()
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer
    
    local oldKick = LocalPlayer.Kick
    LocalPlayer.Kick = function(self, reason)
        if getgenv().AntiKick then
            return nil
        end
        return oldKick(self, reason)
    end
end

function StartStealthFly()
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer
    local RunService = game:GetService("RunService")
    local UserInputService = game:GetService("UserInputService")
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoid or not rootPart then return end
    
    local flyPart = Instance.new("Part")
    flyPart.Name = "StealthAnchor"
    flyPart.Anchored = true
    flyPart.CanCollide = false
    flyPart.Transparency = 1
    flyPart.Size = Vector3.new(1, 1, 1)
    flyPart.Parent = workspace
    
    local bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.Name = "StealthVelocity"
    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    bodyVelocity.MaxForce = Vector3.new(40000, 40000, 40000)
    bodyVelocity.Parent = flyPart
    
    local weld = Instance.new("Weld")
    weld.Part0 = rootPart
    weld.Part1 = flyPart
    weld.C0 = CFrame.new()
    weld.Parent = rootPart
    
    getgenv().Stealth.FlyConnection = RunService.Heartbeat:Connect(function()
        if not getgenv().Stealth.Active then return end
        
        flyPart.CFrame = rootPart.CFrame
        
        local moveDir = Vector3.new(0, 0, 0)
        
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then
            moveDir = moveDir + rootPart.CFrame.LookVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then
            moveDir = moveDir - rootPart.CFrame.LookVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then
            moveDir = moveDir - rootPart.CFrame.RightVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then
            moveDir = moveDir + rootPart.CFrame.RightVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
            moveDir = moveDir + Vector3.new(0, 1, 0)
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
            moveDir = moveDir - Vector3.new(0, 1, 0)
        end
        
        if moveDir.Magnitude > 0 then
            moveDir = moveDir.Unit * getgenv().FlySpeed
            bodyVelocity.Velocity = moveDir
        else
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        end
    end)
    
    getgenv().Stealth.Active = true
end

function StopStealthFly()
    getgenv().Stealth.Active = false
    
    if getgenv().Stealth.FlyConnection then
        getgenv().Stealth.FlyConnection:Disconnect()
    end
    
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer
    local character = LocalPlayer.Character
    
    if character then
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        if rootPart then
            for _, weld in pairs(rootPart:GetChildren()) do
                if weld:IsA("Weld") and weld.Part1 and weld.Part1.Name == "StealthAnchor" then
                    weld.Part1:Destroy()
                    weld:Destroy()
                end
            end
        end
    end
    
    if workspace:FindFirstChild("StealthAnchor") then
        workspace.StealthAnchor:Destroy()
    end
end

local UIS = game:GetService("UserInputService")
UIS.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode[getgenv().FlyKey or "F"] then
        FlyToggle:Set(not getgenv().Stealth.Active)
    end
end)

getgenv().FlySpeed = 50
getgenv().FlyKey = "F"
getgenv().AntiKick = false

Rayfield:Notify({
    Title = "Stealth Fly Loaded",
    Content = "Enable protection first!",
    Duration = 5,
})
