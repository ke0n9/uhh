--[[
    Advanced Remote Spy
    by axel ganteng
    Using Official WindUI
--]]

local WindUI

do
    local ok, result = pcall(function()
        return require("./src/Init")
    end)
    
    if ok then
        WindUI = result
    else 
        WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()
    end
end

-- Create Window
local Window = WindUI:CreateWindow({
    Title = "Remote Spy | by axel ganteng",
    Author = "by axel ganteng",
    Folder = "RemoteSpyConfig",
    Icon = "search",
})

-- ========== GLOBAL VARIABLES ==========
getgenv().RemoteSpy = {
    Enabled = false,
    MonitorRemotes = true,
    AutoBlock = false,
    LogCalls = true,
    MaxLogs = 200
}

-- Data Storage
local RemoteData = {
    Logs = {},
    HookedRemotes = {},
    OriginalFunctions = {},
    FoundRemotes = {},
    SelectedRemote = nil
}

-- ========== CREATE TABS ==========
local MainTab = Window:Tab({
    Title = "Main",
    Icon = "home",
    Desc = "Main controls and status"
})

local ScannerTab = Window:Tab({
    Title = "Scanner", 
    Icon = "search",
    Desc = "Remote scanning tools"
})

local RemoteTab = Window:Tab({
    Title = "Remotes",
    Icon = "list",
    Desc = "Remote management"
})

local SecurityTab = Window:Tab({
    Title = "Security",
    Icon = "shield",
    Desc = "Security settings"
})

-- Select first tab
Window:SelectTab(1)

-- ========== MAIN TAB ==========
MainTab:Section({Title = "Remote Spy Controls"})

local StatusLabel = MainTab:Label("ðŸ”´ System: OFFLINE")

local SpyToggle = MainTab:Toggle({
    Title = "Enable Remote Spy",
    Default = false,
    Callback = function(Value)
        getgenv().RemoteSpy.Enabled = Value
        updateStatus()
        if Value then
            startRemoteSpy()
        else
            stopRemoteSpy()
        end
    end
})

local MonitorToggle = MainTab:Toggle({
    Title = "Monitor Remote Calls",
    Default = true,
    Callback = function(Value)
        getgenv().RemoteSpy.MonitorRemotes = Value
    end
})

MainTab:Section({Title = "Quick Actions"})

local ScanBtn = MainTab:Button({
    Title = "Quick Scan",
    Callback = function()
        quickScan()
    end
})

local ClearBtn = MainTab:Button({
    Title = "Clear Logs",
    Callback = function()
        clearLogs()
    end
})

-- ========== SCANNER TAB ==========
ScannerTab:Section({Title = "Scanning Tools"})

local DeepScanBtn = ScannerTab:Button({
    Title = "Deep Scan",
    Callback = function()
        deepScan()
    end
})

local ScriptScanBtn = ScannerTab:Button({
    Title = "Scan Scripts",
    Callback = function()
        scanScripts()
    end
})

ScannerTab:Section({Title = "Scan Results"})

local ResultsLabel = ScannerTab:Label("No scan performed yet")

-- ========== REMOTE TAB ==========
RemoteTab:Section({Title = "Remote Selection"})

local RemoteDropdown = RemoteTab:Dropdown({
    Title = "Select Remote",
    Values = {"No remotes found"},
    Value = "No remotes found",
    Callback = function(Option)
        selectRemote(Option)
    end
})

RemoteTab:Section({Title = "Copy Tools"})

local CopyPathBtn = RemoteTab:Button({
    Title = "Copy Path",
    Callback = function()
        copyRemotePath()
    end
})

local CopyNameBtn = RemoteTab:Button({
    Title = "Copy Name", 
    Callback = function()
        copyRemoteName()
    end
})

local CopyScriptBtn = RemoteTab:Button({
    Title = "Copy Fire Script",
    Callback = function()
        copyFireScript()
    end
})

local CopyHookBtn = RemoteTab:Button({
    Title = "Copy Hook Script",
    Callback = function()
        copyHookScript()
    end
})

-- ========== SECURITY TAB ==========
SecurityTab:Section({Title = "Security Settings"})

local BlockToggle = SecurityTab:Toggle({
    Title = "Auto Block Suspicious",
    Default = false,
    Callback = function(Value)
        getgenv().RemoteSpy.AutoBlock = Value
    end
})

local AlertToggle = SecurityTab:Toggle({
    Title = "Alert on Suspicious",
    Default = true,
    Callback = function(Value)
        -- Alert setting
    end
})

SecurityTab:Section({Title = "Security Actions"})

local BlockAllBtn = SecurityTab:Button({
    Title = "Block All Remotes",
    Callback = function()
        blockAllRemotes()
    end
})

local UnblockAllBtn = SecurityTab:Button({
    Title = "Unblock All Remotes",
    Callback = function()
        unblockAllRemotes()
    end
})

-- ========== CORE FUNCTIONS ==========

function startRemoteSpy()
    WindUI:Notify({
        Title = "Remote Spy",
        Content = "Starting remote spy...",
        Icon = "loader"
    })
    
    findAndHookRemotes()
    
    -- Monitor new remotes
    game.DescendantAdded:Connect(function(obj)
        if isRemote(obj) then
            hookRemote(obj)
        end
    end)
    
    updateStatus()
    WindUI:Notify({
        Title = "Remote Spy", 
        Content = "Remote spy started successfully!",
        Icon = "check"
    })
end

function stopRemoteSpy()
    for remote, original in pairs(RemoteData.OriginalFunctions) do
        restoreRemote(remote)
    end
    
    RemoteData.HookedRemotes = {}
    updateStatus()
    
    WindUI:Notify({
        Title = "Remote Spy",
        Content = "Remote spy stopped!",
        Icon = "power"
    })
end

function findAndHookRemotes()
    local services = {
        game:GetService("ReplicatedStorage"),
        game:GetService("ServerStorage"), 
        game:GetService("ServerScriptService"),
        game:GetService("Players")
    }
    
    for _, service in pairs(services) do
        for _, obj in pairs(service:GetDescendants()) do
            if isRemote(obj) then
                hookRemote(obj)
                addToFoundRemotes(obj)
            end
        end
    end
    
    updateRemoteDropdown()
end

function isRemote(obj)
    return obj:IsA("RemoteEvent") or obj:IsA("RemoteFunction") or obj:IsA("BindableEvent")
end

function hookRemote(remote)
    if RemoteData.HookedRemotes[remote] then return end
    
    if remote:IsA("RemoteEvent") then
        hookRemoteEvent(remote)
    elseif remote:IsA("RemoteFunction") then
        hookRemoteFunction(remote) 
    elseif remote:IsA("BindableEvent") then
        hookBindableEvent(remote)
    end
    
    RemoteData.HookedRemotes[remote] = true
end

function hookRemoteEvent(remote)
    local original = remote.FireServer
    RemoteData.OriginalFunctions[remote] = original
    
    remote.FireServer = function(self, ...)
        local args = {...}
        logRemoteCall(remote, "RemoteEvent", args)
        
        if not shouldBlock(remote, args) then
            return original(self, ...)
        end
    end
end

function hookRemoteFunction(remote)
    local original = remote.InvokeServer
    RemoteData.OriginalFunctions[remote] = original
    
    remote.InvokeServer = function(self, ...)
        local args = {...}
        logRemoteCall(remote, "RemoteFunction", args)
        
        if not shouldBlock(remote, args) then
            return original(self, ...)
        else
            return nil
        end
    end
end

function hookBindableEvent(bindable)
    local original = bindable.Fire
    RemoteData.OriginalFunctions[bindable] = original
    
    bindable.Fire = function(self, ...)
        local args = {...}
        logRemoteCall(bindable, "BindableEvent", args)
        return original(self, ...)
    end
end

function shouldBlock(remote, args)
    if not getgenv().RemoteSpy.AutoBlock then return false end
    
    local name = remote.Name:lower()
    local suspicious = {"kick", "ban", "punish", "reset", "crash"}
    
    for _, pattern in ipairs(suspicious) do
        if name:find(pattern) then
            WindUI:Notify({
                Title = "ðŸš¨ Blocked Suspicious Remote",
                Content = "Blocked: " .. remote.Name,
                Icon = "shield-alert"
            })
            return true
        end
    end
    
    return false
end

function logRemoteCall(remote, type, args)
    if not getgenv().RemoteSpy.LogCalls then return end
    
    local log = {
        Time = os.date("%X"),
        Name = remote.Name,
        Type = type,
        Args = args
    }
    
    table.insert(RemoteData.Logs, 1, log)
    
    if #RemoteData.Logs > getgenv().RemoteSpy.MaxLogs then
        table.remove(RemoteData.Logs)
    end
    
    print(string.format("[%s] %s %s", log.Time, log.Name, log.Type))
end

-- ========== SCANNING FUNCTIONS ==========

function quickScan()
    RemoteData.FoundRemotes = {}
    findAndHookRemotes()
    
    WindUI:Notify({
        Title = "Scan Complete",
        Content = "Found " .. #RemoteData.FoundRemotes .. " remotes",
        Icon = "search"
    })
    
    ResultsLabel:Set("Found " .. #RemoteData.FoundRemotes .. " remotes")
end

function deepScan()
    RemoteData.FoundRemotes = {}
    
    for _, service in pairs(game:GetChildren()) do
        for _, obj in pairs(service:GetDescendants()) do
            if isRemote(obj) then
                addToFoundRemotes(obj)
            end
        end
    end
    
    updateRemoteDropdown()
    ResultsLabel:Set("Deep scan found " .. #RemoteData.FoundRemotes .. " remotes")
end

function scanScripts()
    WindUI:Notify({
        Title = "Script Scan",
        Content = "Script scanning started",
        Icon = "file-text"
    })
end

function addToFoundRemotes(remote)
    local info = {
        Object = remote,
        Name = remote.Name,
        Type = remote.ClassName,
        Path = remote:GetFullName()
    }
    
    table.insert(RemoteData.FoundRemotes, info)
end

-- ========== COPY FUNCTIONS ==========

function selectRemote(option)
    if option == "No remotes found" then return end
    
    for _, remote in pairs(RemoteData.FoundRemotes) do
        if remote.Name == option then
            RemoteData.SelectedRemote = remote
            WindUI:Notify({
                Title = "Remote Selected",
                Content = "Selected: " .. remote.Name,
                Icon = "check"
            })
            break
        end
    end
end

function copyRemotePath()
    if not RemoteData.SelectedRemote then
        WindUI:Notify({
            Title = "Error",
            Content = "No remote selected!",
            Icon = "x"
        })
        return
    end
    
    setclipboard(RemoteData.SelectedRemote.Path)
    WindUI:Notify({
        Title = "Copied",
        Content = "Path copied to clipboard",
        Icon = "copy"
    })
end

function copyRemoteName()
    if not RemoteData.SelectedRemote then
        WindUI:Notify({
            Title = "Error", 
            Content = "No remote selected!",
            Icon = "x"
        })
        return
    end
    
    setclipboard(RemoteData.SelectedRemote.Name)
    WindUI:Notify({
        Title = "Copied",
        Content = "Name copied to clipboard", 
        Icon = "copy"
    })
end

function copyFireScript()
    if not RemoteData.SelectedRemote then
        WindUI:Notify({
            Title = "Error",
            Content = "No remote selected!",
            Icon = "x"
        })
        return
    end
    
    local remote = RemoteData.SelectedRemote
    local script = ""
    
    if remote.Type == "RemoteEvent" then
        script = string.format([[
local remote = game:GetService("ReplicatedStorage"):WaitForChild("%s")
if remote:IsA("RemoteEvent") then
    remote:FireServer()
end
        ]], remote.Name)
        
    elseif remote.Type == "RemoteFunction" then
        script = string.format([[
local remote = game:GetService("ReplicatedStorage"):WaitForChild("%s") 
if remote:IsA("RemoteFunction") then
    local result = remote:InvokeServer()
    return result
end
        ]], remote.Name)
        
    elseif remote.Type == "BindableEvent" then
        script = string.format([[
local bindable = game:GetService("ReplicatedStorage"):WaitForChild("%s")
if bindable:IsA("BindableEvent") then
    bindable:Fire()
end
        ]], remote.Name)
    end
    
    setclipboard(script)
    WindUI:Notify({
        Title = "Copied",
        Content = "Fire script copied!",
        Icon = "copy"
    })
end

function copyHookScript()
    if not RemoteData.SelectedRemote then
        WindUI:Notify({
            Title = "Error",
            Content = "No remote selected!",
            Icon = "x"
        })
        return
    end
    
    local remote = RemoteData.SelectedRemote
    local script = string.format([[
-- Hook %s: %s
local remote = game:GetService("ReplicatedStorage"):WaitForChild("%s")
local original = remote.%s

remote.%s = function(self, ...)
    local args = {...}
    print("Remote Called:", remote.Name, args)
    return original(self, ...)
end
    ]],
    remote.Type, remote.Name,
    remote.Name,
    remote.Type == "RemoteEvent" and "FireServer" or 
    remote.Type == "RemoteFunction" and "InvokeServer" or "Fire",
    remote.Type == "RemoteEvent" and "FireServer" or 
    remote.Type == "RemoteFunction" and "InvokeServer" or "Fire"
    )
    
    setclipboard(script)
    WindUI:Notify({
        Title = "Copied", 
        Content = "Hook script copied!",
        Icon = "copy"
    })
end

-- ========== UTILITY FUNCTIONS ==========

function updateStatus()
    local status = getgenv().RemoteSpy.Enabled and "ðŸŸ¢ ONLINE" or "ðŸ”´ OFFLINE"
    StatusLabel:Set(status .. " | Hooked: " .. getTableLength(RemoteData.HookedRemotes) .. " | Logs: " .. #RemoteData.Logs)
end

function updateRemoteDropdown()
    local options = {"Select a remote..."}
    
    for _, remote in pairs(RemoteData.FoundRemotes) do
        table.insert(options, remote.Name)
    end
    
    RemoteDropdown:Refresh(options)
end

function getTableLength(t)
    local count = 0
    for _ in pairs(t) do count = count + 1 end
    return count
end

function clearLogs()
    RemoteData.Logs = {}
    updateStatus()
    WindUI:Notify({
        Title = "Cleared",
        Content = "All logs cleared!",
        Icon = "trash"
    })
end

function blockAllRemotes()
    for remote, _ in pairs(RemoteData.HookedRemotes) do
        if remote:IsA("RemoteEvent") then
            remote.FireServer = function() end
        elseif remote:IsA("RemoteFunction") then
            remote.InvokeServer = function() return nil end
        end
    end
    WindUI:Notify({
        Title = "Blocked",
        Content = "All remotes blocked!",
        Icon = "shield"
    })
end

function unblockAllRemotes()
    for remote, original in pairs(RemoteData.OriginalFunctions) do
        if remote:IsA("RemoteEvent") then
            remote.FireServer = original
        elseif remote:IsA("RemoteFunction") then
            remote.InvokeServer = original
        end
    end
    WindUI:Notify({
        Title = "Unblocked",
        Content = "All remotes unblocked!",
        Icon = "shield-off"
    })
end

function restoreRemote(remote)
    local original = RemoteData.OriginalFunctions[remote]
    if original then
        if remote:IsA("RemoteEvent") then
            remote.FireServer = original
        elseif remote:IsA("RemoteFunction") then
            remote.InvokeServer = original
        elseif remote:IsA("BindableEvent") then
            remote.Fire = original
        end
    end
end

-- Auto quick scan on start
spawn(function()
    wait(2)
    quickScan()
end)
